
{{ partial "header" . }}

<div class="pull-right">
  <div class="pull-left">
    {{ if .Data.CronRunning }}
    Emails are scheduled <a class="btn btn-info" href="/user">Modify Settings</a>&nbsp;&nbsp;
    {{ else }}
      To Receive Emails <a class="btn btn-danger" href="/user">Configure Time to Send</a>&nbsp;&nbsp;
    {{ end }}
  </div>

<!-- Post to /run?save=false if you don't want to persist changes -->
<form action="/run" method="post" style="float:left">
  <button type="submit" class="btn btn-success">Check Latest Updates</button>
</form>

</div>

{{ with .Context }}
<div class="row">
  <div class="col-md-10">

{{ range $repo:=.Repos }}

<form action="/" method="post" class="form-horizontal text-left">
{{ with $repo }}

{{ if eq .Repo "" }}

<a name="new"></a>
<h2>Track new</h2>

<h4>Click on one of the following to get started</h4>
<ul id="typeaheadUsage">
<li><code>docker</code> <code>rails</code> <code>react</code> <code>awesome-go</code> <code>caddy</code> </li>
<li><code>rea user:facebook</code> - Finds all repos from "facebook" org having "rea" </li>
<!-- <li><code>user:defunkt forks:>100</code> - List all repos from "defunkt" user with more than "100" forks </li>
<li><code>fork:true</code> - to include forked repos (by default only non-forked repostories are present)</li>
<li><code>fork:only</code> - excludes default parent repos</li>
<li><code>stars:10..100</code> - list repositories that have 10 to 100 stars</li>
<li><code>size:>=30000</code> - List repositories that are at least 30 MB</li>
<li><code>webos created:<2011-01-01</code> Matches repositories with "webos" that were created before "2011"</li> -->
<li><code>language:go</code> - includes only those are of Go</li>
<li><code>jquery in:name,description</code> - search for "jquery" in name and description</li>
<li><code>caddy in:name,readme</code> - search for caddy in the name and readme</li>
</ul>
  <div class="form-group">
    <label for="repo" class="col-sm-4 control-label">Repository Name</label>
    <div class="col-sm-8">
      <input type="text" class="form-control" id="repoNew" value="{{ .Repo }}" name="repo">
      <p class="help-block">Add the name of the github repository to track <br>
      <a href="https://developer.github.com/v3/search/#search-repositories" target="_blank">Advanced Usage Guide</a><br>
      </p>
    </div>
  </div>

{{ else }}
  <a name="{{.Repo}}"></a>
  <h2>Edit "{{ .Repo }}"</h2>
  <div class="form-group">
    <label for="repo" class="col-sm-4 control-label">Repository Name</label>
    <div class="col-sm-8">
      <input type="hidden" name="repo" value="{{ .Repo }}">
      <p class="form-control-static"><a target="_blank" rel="none" href="https://github.com/{{.Repo}}">{{ .Repo }}</a></p>
      <!-- <input type="text" class="form-control" id="repo" value="{{ .Repo }}" readonly="readonly"> -->
    </div>
  </div>
{{ end }}

<div class="form-group">
  <div class="col-sm-offset-4 col-sm-4">
    <div class="checkbox">
      <label>
        <input type="hidden" name="branches" value="false" />
        <input type="checkbox" name="branches" value="true" {{if .Branches }}checked="checked"{{end}} > Track New Branches
      </label>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="checkbox">
      <label>
        <input type="hidden" name="tags" value="false" />
        <input type="checkbox" name="tags" value="true" {{if .Tags }}checked="checked"{{end}} > Track New Tags
      </label>
    </div>
  </div>
</div>

<div class="form-group">
  <label for="references" class="col-sm-4 control-label">Track Branches</label>
  <div class="col-sm-8">
    <input type="text" class="form-control" id="references" value="{{ range $i, $x := .NamedReferences }}{{ $x }},{{ end }}" name="references">
    <p class="help-block">Get code diffs in email for these branches</p>
  </div>
</div>

<div class="form-group">
  <div class="col-sm-offset-4 col-sm-8">
    <button type="submit" class="btn btn-success">{{ if eq .Repo "" }}Create{{else}}Update{{end}}</button>
  </div>
</div>

{{ if eq .Repo "" }}
<script>
$('#typeaheadUsage code').on('click', function() {
  var t = $(this).text();
  $('#repoNew').val(t).trigger("input").focus();
})

var repoNames = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.whitespace,
  queryTokenizer: Bloodhound.tokenizers.obj.whitespace('full_name', 'description'),
  remote: {
    url: '/typeahead/repo?repo=%QUERY',
    wildcard: '%QUERY'
  }
});

compileOutput = function(result) {
  var output = "<div><strong>"+result.full_name+"</strong>"
  if (result.homepage != "") {
    output += (" | "+result.homepage);
  }
  output += "<p>"
  if (result.description.length > 50) {
    output += result.description.substr(0,50) + ".."
  } else {
    output += result.description
  }
  output += "</p>"
  return output
}

$('input#repoNew').typeahead(null, {
  name: 'repo',
  limit: 20,
  hint: false,
  highlight: false,
  minLength: 1,
  source: repoNames,
  displayKey: 'full_name',
  templates: {
    empty: [
      '<div class="empty-message">',
        'could not find any repositories matching the criteria',
      '</div>'
    ].join('\n'),
    suggestion: compileOutput
  }
});

var selectedRepoName = "";

$('input#repoNew').on('focusout', function() {
  if (selectedRepoName == $(this).val()) {
    return;
  }
  selectedRepoName = $(this).val();
  var branchInput = $(this).parents('form').find('#references');
  $.ajax({
    url: "/typeahead/branch?repo="+selectedRepoName,
    format: "json",
    cache: true,
    success: function(result) {
      var branch = JSON.parse(result).default_branch
      branchInput.val(branch)
    },
    failure: function() {
      console.log("Repo does not exist")
    }
  });
})

</script>
{{ end }}

{{ end }}
</form>
{{ if eq .Repo "" }}{{else}}
<form action="/" method="post">
<input type="hidden" name="repo" value="{{ .Repo }}">
<input type="hidden" name="_delete" value="true">
<button type="submit" style="position: relative;left: 50px;top: -50px;" href="" class="btn btn-danger">Remove</button>
</form>
{{end}}
<hr />
{{ end }}

</div>
<div class="col-md-2">
  <ul class="list-group" style="position:fixed">
    {{ range .Repos }}
    <li class="list-group-item"><strong>{{ if eq .Repo "" }}<a href="#new">Track new{{else}}<a href="#{{.Repo}}">{{.Repo}}{{end}}</a></strong></li>
    {{ end }}
  </ul>
</div>
</div>

{{ end }}
{{ partial "footer" . }}
